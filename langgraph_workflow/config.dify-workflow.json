{
	"workflow": {
		"entry_point": "user_input",
		"nodes": {
			"user_input": {
				"type": "input",
				"data": {
					"title": "测试用例生成输入",
					"fields": [
						{
							"name": "figma_yaml_file",
							"type": "file",
							"required": true,
							"description": "上传从 Figma API 或导出的 YAML 页面结构"
						},
						{
							"name": "viewpoints_file",
							"type": "file",
							"required": true,
							"description": "上传测试观点（viewpoints.yaml / JSON）"
						},
						{
							"name": "history_cases_file",
							"type": "file",
							"required": false,
							"description": "上传历史测试用例（可选，JSON/CSV）"
						},
						{
							"name": "manual_frame_selection",
							"type": "checkbox",
							"required": false,
							"default": false,
							"description": "手动选择需要测试的Frame（勾选后将显示Frame列表供选择）"
						}
					]
				},
				"next": "load_page"
			},

			"load_page": {
				"type": "http",
				"priority": "high",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/load_page/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"figma_yaml": "{{figma_yaml_file.content}}",
						"extract_frames_only": "{{manual_frame_selection}}"
					}
				},
				"next": {
					"condition": "{{manual_frame_selection}}",
					"true": "select_frames",
					"false": ["match_viewpoints", "route_infer"]
				}
			},

			"select_frames": {
				"type": "form",
				"priority": "high",
				"data": {
					"title": "选择需要测试的Frame",
					"description": "请从下面的列表中选择需要包含在测试中的Frame，按页面分组显示",
					"fields": [
						{
							"name": "selected_frames",
							"type": "checkboxes",
							"options": "{{load_page.response.available_frames}}",
							"required": true,
							"description": "已找到 {{load_page.response.frames_count}} 个Frame，分布在 {{load_page.response.pages.length}} 个页面中"
						},
						{
							"name": "selection_info",
							"type": "display",
							"content": "选择包含交互元素的Frame可以获得更好的测试效果。交互元素包括按钮、输入框、链接等。"
						}
					]
				},
				"next": "process_selected_frames"
			},

			"process_selected_frames": {
				"type": "http",
				"priority": "high",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/process_selected_frames/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"figma_cache_id": "{{load_page.response.cache_id}}",
						"selected_frames": "{{selected_frames}}"
					}
				},
				"next": ["match_viewpoints", "route_infer"]
			},

			"match_viewpoints": {
				"type": "http",
				"priority": "high",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/match_viewpoints/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"clean_json_cache_id": "{{#if process_selected_frames.response.cache_id}}{{process_selected_frames.response.cache_id}}{{else}}{{load_page.response.cache_id}}{{/if}}",
						"viewpoints": "{{viewpoints_file.content}}"
					}
				},
				"next": "generate_testcases"
			},

			"generate_testcases": {
				"type": "http",
				"priority": "medium",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/generate_testcases/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"component_viewpoints_cache_id": "{{match_viewpoints.response.cache_id}}",
						"agent_config": {
							"provider": "openai",
							"api_key": "{{api_key}}",
							"model": "gpt-4o",
							"temperature": 0.3
						},
						"parallel": true,
						"max_workers": 4
					}
				},
				"next": "wait_for_parallel"
			},

			"route_infer": {
				"type": "http",
				"priority": "high",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/route_infer/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"clean_json_cache_id": "{{#if process_selected_frames.response.cache_id}}{{process_selected_frames.response.cache_id}}{{else}}{{load_page.response.cache_id}}{{/if}}"
					}
				},
				"next": "wait_for_parallel"
			},

			"wait_for_parallel": {
				"type": "condition",
				"priority": "high",
				"data": {
					"conditions": [
						{
							"condition": "{{generate_testcases.response}} != null && {{route_infer.response}} != null",
							"next": "generate_cross_page_case"
						}
					],
					"default": "wait_for_parallel"
				}
			},

			"generate_cross_page_case": {
				"type": "http",
				"priority": "medium",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/generate_cross_page_case/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"routes_cache_id": "{{route_infer.response.cache_id}}",
						"testcases_cache_id": "{{generate_testcases.response.cache_id}}",
						"agent_config": {
							"provider": "openai",
							"api_key": "{{api_key}}",
							"model": "gpt-4o",
							"temperature": 0.2
						}
					}
				},
				"next": "format_output"
			},

			"format_output": {
				"type": "http",
				"priority": "low",
				"data": {
					"method": "POST",
					"url": "http://host.docker.internal:8000/run_node/format_output/",
					"headers": {
						"Content-Type": "application/json"
					},
					"body": {
						"testcases": "{{generate_cross_page_case.response.content}}",
						"format": "markdown"
					}
				},
				"next": "show_result"
			},

			"show_result": {
				"type": "output",
				"priority": "low",
				"data": {
					"title": "结构化测试用例输出（Markdown）",
					"description": "以下是从Figma自动生成的结构化测试用例",
					"display_type": "markdown",
					"content": "{{format_output.response.content}}"
				}
			}
		}
	}
}
